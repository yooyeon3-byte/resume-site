<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragments/layout}">
<body>
<th:block layout:fragment="content">

    <div class="page-header">
        <h2 th:text="${resume.title}">ì´ë ¥ì„œ ì œëª©</h2>

        <th:block th:unless="${isDocxDownload}">
            <a th:href="@{/company/resumes}" th:if="${#authorization.expression('hasRole(''COMPANY'')')}" class="btn-outline small">ëª©ë¡ìœ¼ë¡œ</a>
            <a th:href="@{/admin/resumes}" th:if="${#authorization.expression('hasRole(''ADMIN'')')}" class="btn-outline small">ëª©ë¡ìœ¼ë¡œ</a>
        </th:block>

        <th:block th:unless="${isDocxDownload}">
            <div sec:authorize="hasRole('COMPANY')">
                <form th:action="@{'/company/resumes/' + ${resume.id} + '/toggle-scrap'}" method="post">
                    <button type="submit"
                            th:classappend="${isScrapped} ? 'btn-danger small' : 'btn-outline small'"
                            th:text="${isScrapped} ? 'â­ ìŠ¤í¬ë© ì·¨ì†Œ' : 'â­ ê´€ì‹¬ ì´ë ¥ì„œ ë“±ë¡'"></button>
                </form>
            </div>
        </th:block>
    </div>

    <p class="muted" style="margin-top: -20px; margin-bottom: 25px;">
        ì‘ì„±ì: <span th:text="${resume.owner.name}"></span>
        (<span th:text="${resume.owner.username}"></span>) |
        ì‘ì„±ì¼: <span th:text="${#temporals.format(resume.createdAt, 'yyyy.MM.dd HH:mm')}"></span>
    </p>

    <div class="card detail-section">
        <h3>â–  ì¸ì  ì‚¬í•­ ë° ì§€ì› ì •ë³´</h3>
        <div style="display: flex; gap: 40px;">
            <div style="flex-shrink: 0;">
                <th:block th:if="${resume.photoPath}">
                    <img th:if="${isDocxDownload}"
                         th:src="${absolutePhotoUri}"
                         style="width: 120px; height: 160px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px;"
                         alt="ì¦ëª…ì‚¬ì§„">

                    <img th:unless="${isDocxDownload}"
                         th:src="@{${resume.photoPath}}"
                         style="width: 120px; height: 160px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px;"
                         alt="ì¦ëª…ì‚¬ì§„">
                </th:block>

                <div th:unless="${resume.photoPath}" style="width: 120px; height: 160px; border: 1px dashed #ccc; text-align: center; line-height: 160px; font-size: 14px; color: #888;">
                    ì‚¬ì§„ ì—†ìŒ
                </div>
            </div>

            <table class="table" style="width: 100%; max-width: 400px; margin-top: 0;">
                <tr><th style="width: 30%; background-color: #f7f7f7;">ì§€ì› ë¶„ì•¼</th><td th:text="${resume.title}"></td></tr>
                <tr><th style="width: 30%; background-color: #f7f7f7;">ì„±ëª…</th><td th:text="${resume.name}"></td></tr>
                <tr><th style="width: 30%; background-color: #f7f7f7;">ìƒë…„ì›”ì¼</th><td th:text="${resume.birthDate}"></td></tr>
                <tr><th style="width: 30%; background-color: #f7f7f7;">ì£¼ì†Œ</th><td th:text="${resume.address}"></td></tr>
                <tr><th style="width: 30%; background-color: #f7f7f7;">ì „í™”</th><td th:text="${resume.phone}"></td></tr>
                <tr><th style="width: 30%; background-color: #f7f7f7;">ì´ë©”ì¼</th><td th:text="${resume.email}"></td></tr>
                <tr><th style="width: 30%; background-color: #f7f7f7;">ì„±ë³„</th><td th:text="${resume.gender}"></td></tr>
                <tr><th style="width: 30%; background-color: #f7f7f7;">ê¸´ê¸‰ ì—°ë½ì²˜</th><td th:text="${resume.personalContact}"></td></tr>
                <tr><th style="width: 30%; background-color: #f7f7f7;">ê³µê°œ ì—¬ë¶€</th>
                    <td th:styleappend="${resume.isPublic} ? 'color: var(--color-cta-green); font-weight: 600;' : 'color: var(--color-danger); font-weight: 600;'"
                        th:text="${resume.isPublic} ? 'âœ… ê³µê°œë¨' : 'ğŸ”’ ë¹„ê³µê°œ'">
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div class="card detail-section">
        <h3>â–  ë³‘ì—­ ì‚¬í•­</h3>
        <table class="table" style="width: 100%; max-width: 600px; margin-top: 0;">
            <tr><th style="width: 25%;">ë³‘ì—­êµ¬ë¶„</th><td th:text="${resume.militaryStatus}"></td></tr>
            <tr><th>êµ°ë³„/ê³„ê¸‰/ë³‘ê³¼</th><td th:text="${resume.militaryBranch + ' / ' + resume.militaryRank + ' / ' + resume.militarySpecialty}"></td></tr>
            <tr>
                <th>ë³µë¬´ê¸°ê°„</th>
                <td th:text="${(resume.militaryStartDate ?: '') + (resume.militaryStartDate != null or resume.militaryEndDate != null ? ' ~ ' : '') + (resume.militaryEndDate ?: '')}">
                </td>
            </tr>
            <tr><th>ë³´í›ˆëŒ€ìƒ</th><td th:text="${resume.veteranBenefit ? 'ëŒ€ìƒ' : 'ë¹„ëŒ€ìƒ'}"></td></tr>
        </table>
    </div>

    <div class="card detail-section">
        <h3>â–  í•™ë ¥ ì‚¬í•­</h3>
        <div id="educationTableContainer" class="json-table-container"></div>
    </div>

    <div class="card detail-section">
        <h3>â–  ê²½ë ¥ ì‚¬í•­</h3>
        <div id="experienceTableContainer" class="json-table-container"></div>
    </div>

    <div class="card detail-section">
        <h3>â–  ìê²©ì¦/ë©´í—ˆì¦</h3>
        <div id="certificateTableContainer" class="json-table-container"></div>
    </div>

    <div class="card detail-section">
        <h3>â–  ëŒ€ì™¸í™œë™ ê²½í—˜</h3>
        <div id="activityTableContainer" class="json-table-container"></div>
    </div>

    <div class="card detail-section">
        <h3>â–  ìê¸°ì†Œê°œì„œ</h3>
        <pre class="content-text" th:text="${resume.selfIntroduction}"></pre>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // Thymeleafì—ì„œ JSON ë¬¸ìì—´ì„ JavaScript String ë¦¬í„°ëŸ´ë¡œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const educationJson = /*[[${resume.educationHistory}]]*/ '[]';
            const experienceJson = /*[[${resume.experienceHistory}]]*/ '[]';
            const certificateJson = /*[[${resume.certificationsAndSkills}]]*/ '[]';
            const activityJson = /*[[${resume.extracurricularActivities}]]*/ '[]';

            // í—¬í¼ í•¨ìˆ˜: JSON í‚¤ë¥¼ í•œê¸€ í—¤ë”ë¡œ ë³€í™˜ (startDate/endDate ë°˜ì˜)
            const headerMap = {
                // í•™ë ¥ - 'ì‹œì‘ì¼', 'ì¢…ë£Œì¼'ì„ 'ì…í•™ì¼', 'ì¡¸ì—…ì¼'ë¡œ ë³€ê²½
                schoolName: 'í•™êµëª…', startDate: 'ì…í•™ì¼', endDate: 'ì¡¸ì—…ì¼', major: 'ì „ê³µ', notes: 'ë¹„ê³ ',
                // ê²½ë ¥
                companyName: 'íšŒì‚¬ëª…/ì§ìœ„', startDate: 'ì‹œì‘ì¼', endDate: 'ì¢…ë£Œì¼', responsibility: 'ë‹´ë‹¹ ì—…ë¬´',
                // ìê²©ì¦
                certificateName: 'ìê²©ì¦ëª…', acquisitionDate: 'ì·¨ë“ì¼', publisher: 'ë°œí–‰ì²˜',
                // ëŒ€ì™¸í™œë™
                activityName: 'í™œë™ëª…', startDate: 'ì‹œì‘ì¼', endDate: 'ì¢…ë£Œì¼', organization: 'ê¸°ê´€ëª…/ì£¼ìµœ', details: 'ë‚´ìš©/ë¹„ê³ '
            };

            /**
             * JSON ë¬¸ìì—´ì„ HTML í…Œì´ë¸”ë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
             */
            function renderJsonTable(jsonString, containerId) {
                const container = document.getElementById(containerId);
                let data;

                // JSON.parseë¥¼ ì‹œë„í•˜ê¸° ì „ì— ë¬¸ìì—´ì´ ìœ íš¨í•œì§€ í™•ì¸
                if (!jsonString || jsonString.trim() === '[]') {
                    container.innerHTML = `<p class="muted" style="margin: 0; padding: 10px;">ì‘ì„±ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                try {
                    data = JSON.parse(jsonString);
                } catch (e) {
                    console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e, jsonString);
                    container.innerHTML = `<p style="color: var(--color-danger);">ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ìœ íš¨í•˜ì§€ ì•Šì€ í˜•ì‹ì…ë‹ˆë‹¤.</p><pre>${jsonString}</pre>`;
                    return;
                }

                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = `<p class="muted" style="margin: 0; padding: 10px;">ì‘ì„±ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                // 1. í—¤ë” ìƒì„± (ì²« ë²ˆì§¸ ê°ì²´ì˜ í‚¤ë¥¼ ì‚¬ìš©)
                const allKeys = Object.keys(headerMap);
                const firstItemKeys = Object.keys(data[0]);

                // ë Œë”ë§í•  í‚¤ ìˆœì„œ ì •ì˜ (period ëŒ€ì‹  startDate, endDate í¬í•¨)
                let keysToRender;
                if (containerId === 'educationTableContainer' || containerId === 'experienceTableContainer' || containerId === 'activityTableContainer') {
                    // í•™ë ¥/ê²½ë ¥/ëŒ€ì™¸í™œë™ì€ ìˆœì„œë¥¼ ì¡°ì •í•©ë‹ˆë‹¤ (ì˜ˆ: í•™êµëª…, ì‹œì‘ì¼, ì¢…ë£Œì¼, ì „ê³µ, ë¹„ê³ )
                    keysToRender = ['schoolName', 'companyName', 'activityName', 'organization', 'major', 'notes', 'responsibility', 'details']
                        .filter(k => firstItemKeys.includes(k)) // ì¡´ì¬í•˜ëŠ” í•„í„°ë§
                        .filter(k => k !== 'id')
                        .reduce((acc, k) => {
                            if (!acc.includes(k)) acc.push(k);
                            return acc;
                        }, []);

                    // ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì€ í•­ìƒ ì œëª© ë‹¤ìŒì— ìœ„ì¹˜í•˜ë„ë¡ ì¡°ì •
                    const titleKeyIndex = keysToRender.findIndex(k => k.includes('Name') || k.includes('organization') || k.includes('major'));
                    if (titleKeyIndex !== -1) {
                        // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì œëª©/ì „ê³µ í•„ë“œ ë’¤ì— ì‚½ì… (ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ê·¸ëƒ¥ ëì— ì¶”ê°€ë¨)
                        keysToRender.splice(titleKeyIndex + 1, 0, 'startDate', 'endDate');
                        // ì¤‘ë³µ ì œê±°
                        keysToRender = keysToRender.filter((key, index, self) => self.indexOf(key) === index);
                    } else {
                         keysToRender = ['startDate', 'endDate'].concat(keysToRender);
                         keysToRender = keysToRender.filter((key, index, self) => self.indexOf(key) === index);
                    }

                } else {
                    // ìê²©ì¦ì€ acquisitionDate ê·¸ëŒ€ë¡œ
                    keysToRender = firstItemKeys.filter(key => key !== 'id' && allKeys.includes(key));
                }

                let tableHtml = `<table class="table" style="table-layout: auto; margin-top: 0; width: 100%;"><thead><tr>`;
                keysToRender.forEach(key => {
                    // 'ê¸°ê°„' í•„ë“œê°€ ë¶„ë¦¬ë˜ì—ˆìœ¼ë¯€ë¡œ, ì ì ˆí•œ ë„ˆë¹„ë¥¼ ì„¤ì •
                    tableHtml += `<th style="width: ${key.includes('Date') || key.includes('period') ? '20%' : 'auto'};">${headerMap[key] || key}</th>`;
                });
                tableHtml += `</tr></thead><tbody>`;

                // 2. ë³¸ë¬¸ í–‰ ìƒì„±
                data.forEach(item => {
                    tableHtml += `<tr>`;
                    keysToRender.forEach(key => {
                        const content = item[key] ? item[key].toString() : '';
                        // pre-wrapì„ ì‚¬ìš©í•˜ì—¬ ê¸´ ë‚´ìš©ë„ ì˜ í‘œì‹œë˜ë„ë¡ í•©ë‹ˆë‹¤.
                        tableHtml += `<td style="white-space: pre-wrap; font-size: 14px;">${content}</td>`;
                    });
                    tableHtml += `</tr>`;
                });

                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            }

            // ë Œë”ë§ ì‹¤í–‰
            renderJsonTable(educationJson, 'educationTableContainer');
            renderJsonTable(experienceJson, 'experienceTableContainer');
            renderJsonTable(certificateJson, 'certificateTableContainer');
            renderJsonTable(activityJson, 'activityTableContainer');
        });
    </script>
</th:block>
</body>
</html>