<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <style>
        /* ========================================================= */
        /* 폼 디자인 오버라이드 및 세련된 스타일 (Final) */
        /* ========================================================= */
        .resume-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--color-background);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow-md);
        }
        .form-section-card {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .resume-section-title {
            font-size: 20px;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary-light);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
        }

        /* 인적 사항 그리드 레이아웃 */
        .personal-grid {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 20px;
        }
        .personal-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .personal-row {
             grid-column: span 2;
        }

        /* 사진 박스 스타일 */
        .photo-box {
            width: 100%;
            height: 180px;
            border: 2px dashed var(--color-border);
            border-radius: 8px;
            text-align: center;
            line-height: 180px;
            overflow: hidden;
            display: block;
            cursor: pointer;
            background-color: #fafafa;
        }
        .photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-box .photo-placeholder {
            font-size: 14px;
            color: var(--color-text-subtle);
            line-height: normal;
            padding-top: 75px;
            display: block;
        }

        /* 병역 사항 (2단 레이아웃) */
        .military-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .military-grid .form-group {
            margin-bottom: 0;
        }

        /* 동적 테이블 스타일 (깔끔하게 유지) */
        .resume-table {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--color-border);
            width: 100%; /* 테이블 너비 명시 */
            border-collapse: collapse;
        }
        .resume-table th, .resume-table td {
            border: 1px solid var(--color-border);
            padding: 8px 10px;
            height: 40px; /* 높이 고정 */
        }
        .resume-table input, .resume-table select {
            padding: 8px;
            background-color: transparent;
        }

        /* 컨트롤 버튼 스타일 (작고 세련되게) */
        .control-btn {
            background-color: var(--color-cta-green);
            color: white;
            padding: 5px 12px;
            font-size: 14px;
            border-radius: 6px;
            box-shadow: none;
            transition: background 0.2s;
        }
        .add-row-btn {
            margin-left: 10px;
        }
        .remove-row-btn {
            background-color: var(--color-danger);
            width: 30px;
            height: 30px;
            padding: 0;
            line-height: 30px;
            font-size: 20px;
            border-radius: 6px;
        }
        .input-group-row {
            display: flex;
            align-items: center;
            height: 100%;
        }
        .input-group-row input {
            flex-grow: 1;
            border-right: none !important;
            padding: 5px;
        }

        /* ⭐ 추가: 리스트가 비어 있을 때 테이블 전체를 숨김 */
        .hidden-table {
            display: none !important;
            border: none !important;
        }
    </style>
</head>

<body>
<th:block layout:fragment="content">

    <div class="page-header">
        <h2 th:text="${#fields.hasErrors('resumeForm') ? '입력을 다시 확인해주세요' : '이력서 작성/수정'}"></h2>
        <a th:href="@{/resumes}" class="btn-outline">목록으로</a>
    </div>

    <div class="resume-container">

        <form th:action="${resumeForm.id == null ? '/resumes' : '/resumes/' + resumeForm.id}"
              method="post" th:object="${resumeForm}" enctype="multipart/form-data">
            <h1 style="text-align: center; color: var(--color-primary); margin-bottom: 30px;">입 사 지 원 서</h1>

            <div class="form-section-card">
                <h3 class="resume-section-title">■ 지원 정보</h3>
                <div class="personal-inputs">
                    <label>지원 분야 / 제목
                        <input type="text" th:field="*{title}" placeholder="지원 분야 또는 이력서 제목 (필수)" required>
                        <p th:errors="*{title}" class="field-error"></p>
                    </label>
                    <label>긴급 연락처
                        <input type="text" th:field="*{personalContact}" placeholder="긴급 연락처 (필수)" required>
                        <p th:errors="*{personalContact}" class="field-error"></p>
                    </label>
                </div>
            </div>

            <div class="form-section-card">
                <h3 class="resume-section-title">■ 인적 사항</h3>
                <div class="personal-grid">
                    <label for="photoFile" class="photo-box">
                        <img id="photoPreview"
                             th:src="${resumeForm.existingPhotoPath != null} ? @{${resumeForm.existingPhotoPath}} : ''"
                             th:alt="${resumeForm.existingPhotoPath != null} ? '첨부된 사진' : '사진 첨부'"
                             th:style="${resumeForm.existingPhotoPath != null} ? 'display: block;' : 'display: none;'">
                        <span th:if="${resumeForm.existingPhotoPath == null}" id="photoPlaceholder" class="photo-placeholder">증명사진 첨부 (클릭)</span>
                        <input type="file" id="photoFile" name="photoFile" accept="image/*" onchange="previewImage(event)" style="display: none;">
                        <input type="hidden" th:field="*{existingPhotoPath}">
                    </label>

                    <div class="personal-inputs">
                        <label>성 명
                            <input type="text" th:field="*{name}" required>
                            <p th:errors="*{name}" class="field-error"></p>
                        </label>
                        <label>생년월일
                            <input type="text" th:field="*{birthDate}" placeholder="YYYYMMDD" required>
                            <p th:errors="*{birthDate}" class="field-error"></p>
                        </label>
                        <label class="personal-row">주 소
                            <input type="text" th:field="*{address}" required>
                            <p th:errors="*{address}" class="field-error"></p>
                        </label>
                        <label>전 화
                            <input type="text" th:field="*{phone}" required>
                            <p th:errors="*{phone}" class="field-error"></p>
                        </label>
                        <label>이메일
                            <input type="email" th:field="*{email}" required>
                            <p th:errors="*{email}" class="field-error"></p>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-section-card">
                <h3 class="resume-section-title">■ 병역 사항</h3>
                <div class="military-grid">
                    <label>병역 구분
                        <select th:field="*{militaryStatus}">
                            <option value="미필">미필</option>
                            <option value="군필">군필</option>
                            <option value="면제">면제</option>
                        </select>
                    </label>
                    <label>군별
                        <input type="text" th:field="*{militaryBranch}" placeholder="육군, 해병대 등">
                    </label>
                    <label>계급
                        <input type="text" th:field="*{militaryRank}" placeholder="병장, 대위 등">
                    </label>
                    <label>병과 (특기)
                        <input type="text" th:field="*{militarySpecialty}" placeholder="특기/보직">
                    </label>
                    <label>복무 기간
                        <input type="text" th:field="*{militaryPeriod}" placeholder="YYYY.MM.DD ~ YYYY.MM.DD (XX개월)">
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <input type="checkbox" th:field="*{veteranBenefit}" style="width: auto;">
                        <span>보훈 대상</span>
                    </label>
                </div>
            </div>

            <div class="form-section-card">
                <h3 class="resume-section-title">■ 학력 사항<button type="button" class="btn control-btn add-row-btn" data-target="education-body">+</button></h3>
                <table class="resume-table" th:classappend="${#lists.isEmpty(resumeForm.educationList)} ? 'hidden-table' : ''">
                    <thead>
                    <tr>
                        <th style="width: 30%;">학교명</th>
                        <th style="width: 20%;">재학기간</th>
                        <th style="width: 30%;">전공</th>
                        <th style="width: 20%;">비고/액션</th>
                    </tr>
                    </thead>
                    <tbody id="education-body">
                    <tr th:each="edu, stat : *{educationList}">
                        <td class="p-0"><input type="text" th:field="*{educationList[__${stat.index}__].schoolName}" required></td>
                        <td class="p-0"><input type="text" th:field="*{educationList[__${stat.index}__].period}" placeholder="YYYY.MM~YYYY.MM"></td>
                        <td class="p-0"><input type="text" th:field="*{educationList[__${stat.index}__].major}" placeholder="전공"></td>
                        <td class="p-0">
                            <div class="input-group-row">
                                <input type="text" th:field="*{educationList[__${stat.index}__].notes}" placeholder="졸업/재학">
                                <button type="button" class="btn control-btn remove-row-btn" data-target="education-body" data-index="__${stat.index}__">-</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-section-card">
                <h3 class="resume-section-title">■ 경력 사항<button type="button" class="btn control-btn add-row-btn" data-target="experience-body">+</button></h3>
                <table class="resume-table" th:classappend="${#lists.isEmpty(resumeForm.experienceList)} ? 'hidden-table' : ''">
                    <thead>
                    <tr>
                        <th style="width: 25%;">회사명/직위</th>
                        <th style="width: 20%;">근무기간</th>
                        <th style="width: 55%;">담당업무</th>
                    </tr>
                    </thead>
                    <tbody id="experience-body">
                    <tr th:each="exp, stat : *{experienceList}">
                        <td class="p-0"><input type="text" th:field="*{experienceList[__${stat.index}__].companyName}" required></td>
                        <td class="p-0"><input type="text" th:field="*{experienceList[__${stat.index}__].period}" placeholder="YYYY.MM~YYYY.MM"></td>
                        <td class="p-0">
                            <div class="input-group-row">
                                <input type="text" th:field="*{experienceList[__${stat.index}__].responsibility}" placeholder="담당 업무 및 주요 성과">
                                <button type="button" class="btn control-btn remove-row-btn" data-target="experience-body" data-index="__${stat.index}__">-</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-section-card">
                <h3 class="resume-section-title">■ 자격증/면허증<button type="button" class="btn control-btn add-row-btn" data-target="certificate-body">+</button></h3>
                <table class="resume-table" th:classappend="${#lists.isEmpty(resumeForm.certificationList)} ? 'hidden-table' : ''">
                    <thead>
                    <tr>
                        <th style="width: 40%;">자격증명</th>
                        <th style="width: 30%;">취득일</th>
                        <th style="width: 30%;">발행처</th>
                    </tr>
                    </thead>
                    <tbody id="certificate-body">
                    <tr th:each="cert, stat : *{certificationList}">
                        <td class="p-0"><input type="text" th:field="*{certificationList[__${stat.index}__].certificateName}" required></td>
                        <td class="p-0"><input type="text" th:field="*{certificationList[__${stat.index}__].acquisitionDate}" placeholder="YYYY.MM.DD"></td>
                        <td class="p-0">
                            <div class="input-group-row">
                                <input type="text" th:field="*{certificationList[__${stat.index}__].publisher}" placeholder="발행처">
                                <button type="button" class="btn control-btn remove-row-btn" data-target="certificate-body" data-index="__${stat.index}__">-</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-section-card">
                <h3 class="resume-section-title">■ 대외활동 경험<button type="button" class="btn control-btn add-row-btn" data-target="activity-body">+</button></h3>
                <table class="resume-table" th:classappend="${#lists.isEmpty(resumeForm.activityList)} ? 'hidden-table' : ''">
                    <thead>
                    <tr>
                        <th style="width: 25%;">활동명</th>
                        <th style="width: 20%;">기간</th>
                        <th style="width: 30%;">기관명/주최</th>
                        <th style="width: 25%;">내용/비고</th>
                    </tr>
                    </thead>
                    <tbody id="activity-body">
                    <tr th:each="activity, stat : *{activityList}">
                        <td class="p-0"><input type="text" th:field="*{activityList[__${stat.index}__].activityName}" required></td>
                        <td class="p-0"><input type="text" th:field="*{activityList[__${stat.index}__].period}" placeholder="YYYY.MM~YYYY.MM"></td>
                        <td class="p-0"><input type="text" th:field="*{activityList[__${stat.index}__].organization}" placeholder="기관명/주최"></td>
                        <td class="p-0">
                            <div class="input-group-row">
                                <input type="text" th:field="*{activityList[__${stat.index}__].details}" placeholder="내용/비고">
                                <button type="button" class="btn control-btn remove-row-btn" data-target="activity-body" data-index="__${stat.index}__">-</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>


            <div class="form-section-card">
                <h3 class="resume-section-title">■ 자기소개서</h3>
                <label style="margin-top: 10px;">
                    <textarea th:field="*{selfIntroduction}" rows="12" class="form-control"
                              placeholder="지원 동기, 직무에 대한 강점, 입사 후 포부 등을 자유롭게 작성하세요." style="border: 1px solid var(--color-border);" required></textarea>
                    <p th:errors="*{selfIntroduction}" class="field-error"></p>
                </label>
            </div>


            <button class="btn-primary full large" type="submit" style="margin-top: 10px;">저장하기</button>
        </form>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // =========================================================
            // 1. DYNAMIC ROW HANDLING
            // =========================================================

            // 템플릿 정의 (새 행 추가 시 사용)
            const educationRowTemplate = `
                <tr data-index="INDEX_PLACEHOLDER">
                    <td class="p-0"><input type="text" class="form-control" name="educationList[INDEX_PLACEHOLDER].schoolName" placeholder="학교명" required></td>
                    <td class="p-0"><input type="text" class="form-control" name="educationList[INDEX_PLACEHOLDER].period" placeholder="YYYY.MM~YYYY.MM"></td>
                    <td class="p-0"><input type="text" class="form-control" name="educationList[INDEX_PLACEHOLDER].major" placeholder="전공"></td>
                    <td class="p-0">
                        <div class="input-group-row">
                            <input type="text" class="form-control" name="educationList[INDEX_PLACEHOLDER].notes" placeholder="졸업/재학/휴학">
                            <button type="button" class="btn control-btn remove-row-btn" data-target="education-body" data-index="INDEX_PLACEHOLDER">-</button>
                        </div>
                    </td>
                </tr>
            `;

            const experienceRowTemplate = `
                <tr data-index="INDEX_PLACEHOLDER">
                    <td class="p-0"><input type="text" class="form-control" name="experienceList[INDEX_PLACEHOLDER].companyName" placeholder="회사명/직위" required></td>
                    <td class="p-0"><input type="text" class="form-control" name="experienceList[INDEX_PLACEHOLDER].period" placeholder="YYYY.MM~YYYY.MM"></td>
                    <td class="p-0">
                        <div class="input-group-row">
                            <input type="text" class="form-control" name="experienceList[INDEX_PLACEHOLDER].responsibility" placeholder="담당 업무 및 주요 성과">
                            <button type="button" class="btn control-btn remove-row-btn" data-target="experience-body" data-index="INDEX_PLACEHOLDER">-</button>
                        </div>
                    </td>
                </tr>
            `;

            const certificateRowTemplate = `
                <tr data-index="INDEX_PLACEHOLDER">
                    <td class="p-0"><input type="text" class="form-control" name="certificationList[INDEX_PLACEHOLDER].certificateName" placeholder="자격증명" required></td>
                    <td class="p-0"><input type="text" class="form-control" name="certificationList[INDEX_PLACEHOLDER].acquisitionDate" placeholder="YYYY.MM.DD"></td>
                    <td class="p-0">
                        <div class="input-group-row">
                            <input type="text" class="form-control" name="certificationList[INDEX_PLACEHOLDER].publisher" placeholder="발행처">
                            <button type="button" class="btn control-btn remove-row-btn" data-target="certificate-body" data-index="INDEX_PLACEHOLDER">-</button>
                        </div>
                    </td>
                </tr>
            `;

            // 대외활동 경험 템플릿
            const activityRowTemplate = `
                <tr data-index="INDEX_PLACEHOLDER">
                    <td class="p-0"><input type="text" class="form-control" name="activityList[INDEX_PLACEHOLDER].activityName" placeholder="활동명" required></td>
                    <td class="p-0"><input type="text" class="form-control" name="activityList[INDEX_PLACEHOLDER].period" placeholder="YYYY.MM~YYYY.MM"></td>
                    <td class="p-0"><input type="text" class="form-control" name="activityList[INDEX_PLACEHOLDER].organization" placeholder="기관명/주최"></td>
                    <td class="p-0">
                        <div class="input-group-row">
                            <input type="text" class="form-control" name="activityList[INDEX_PLACEHOLDER].details" placeholder="내용/비고">
                            <button type="button" class="btn control-btn remove-row-btn" data-target="activity-body" data-index="INDEX_PLACEHOLDER">-</button>
                        </div>
                    </td>
                </tr>
            `;


            function addRow(targetBodyId) {
                const targetBody = document.getElementById(targetBodyId);
                let template = '';
                let currentIndex = targetBody.children.length;

                if (targetBodyId === 'education-body') {
                    template = educationRowTemplate;
                } else if (targetBodyId === 'experience-body') {
                    template = experienceRowTemplate;
                } else if (targetBodyId === 'certificate-body') {
                    template = certificateRowTemplate;
                } else if (targetBodyId === 'activity-body') {
                    template = activityRowTemplate;
                } else {
                    return;
                }

                // INDEX_PLACEHOLDER를 현재 인덱스로 치환
                const newRowHtml = template.replace(/INDEX_PLACEHOLDER/g, currentIndex);
                targetBody.insertAdjacentHTML('beforeend', newRowHtml);

                // ⭐ 추가: 행 추가 시 테이블 표시 (hidden-table 클래스 제거)
                const table = targetBody.closest('table');
                if (table.classList.contains('hidden-table')) {
                     table.classList.remove('hidden-table');
                }
            }

            function removeRow(row) {
                const targetBody = row.closest('tbody');
                row.remove();
                reindexRows(targetBody);

                // ⭐ 추가: 마지막 행이 제거되면 테이블을 다시 숨김
                if (targetBody.children.length === 0) {
                     targetBody.closest('table').classList.add('hidden-table');
                }
            }

            function reindexRows(targetBody) {
                const rows = targetBody.querySelectorAll('tr');

                rows.forEach((row, index) => {
                    row.setAttribute('data-index', index);

                    const inputs = row.querySelectorAll('[name]');
                    inputs.forEach(input => {
                        const oldName = input.getAttribute('name');
                        const newName = oldName.replace(/\[\d+\]/g, '[' + index + ']');
                        input.setAttribute('name', newName);
                    });

                    const removeButton = row.querySelector('.remove-row-btn');
                    if (removeButton) {
                        removeButton.setAttribute('data-index', index);
                    }
                });
            }

            // 이벤트 위임으로 '+' 버튼 처리
            document.querySelectorAll('.add-row-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const targetBodyId = this.getAttribute('data-target');
                    addRow(targetBodyId);
                });
            });

            // 이벤트 위임으로 '-' 버튼 처리 (tbody 클릭 이벤트 리스너)
            document.querySelectorAll('.resume-table tbody').forEach(tbody => {
                tbody.addEventListener('click', function(event) {
                    const button = event.target.closest('.remove-row-btn');
                    if (button) {
                        const row = button.closest('tr');
                        if (row) {
                            removeRow(row);
                        }
                    }
                });
            });

            // =========================================================
            // 2. IMAGE PREVIEW HANDLING
            // =========================================================

            window.previewImage = function(event) {
                const preview = document.getElementById('photoPreview');
                const placeholder = document.getElementById('photoPlaceholder');
                const file = event.target.files[0];

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        if (placeholder) placeholder.style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                } else {
                    // 파일 선택 취소 시 기존 상태 복구
                    const existingPath = preview.getAttribute('th:src');
                    if (!existingPath || existingPath.trim() === '') {
                        preview.style.display = 'none';
                        if (placeholder) placeholder.style.display = 'block';
                    }
                }
            };

            // 초기 로드 시 기존 사진 경로가 있으면 플레이스홀더 제거
            const initialPhotoPath = document.getElementById('photoPreview').getAttribute('th:src');
            if (initialPhotoPath && initialPhotoPath.trim() !== '') {
                const placeholder = document.getElementById('photoPlaceholder');
                if (placeholder) placeholder.style.display = 'none';
            }
        });
    </script>
</th:block>
</body>
</html>